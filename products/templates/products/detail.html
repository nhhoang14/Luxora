{% extends 'base.html' %}
{% load vn_currency %}
{% block content %}
<section class="max-w-screen-2xl mx-auto px-4 py-8 mt-4 grid grid-cols-1 md:grid-cols-2 gap-8">
  <!-- Ảnh sản phẩm với Slider -->
  <div class="w-full">
    <!-- Main Image Slider -->
    <div class="aspect-square bg-gray-100 rounded-2xl overflow-hidden relative">
      <div id="imageSlider" class="flex h-full transition-transform duration-500 ease-in-out">
        <!-- Ảnh chính -->
        <div class="w-full h-full flex-shrink-0 flex items-center justify-center">
          {% if product.image %}
            <img src="{{ product.image.url }}" alt="{{ product.name }}"
                 class="w-full h-full object-cover object-center">
          {% else %}
            <span class="text-gray-400">Không có ảnh</span>
          {% endif %}
        </div>

        <!-- Các ảnh phụ thêm (dùng ảnh chính làm mẫu) -->
        {% if product.image %}
        <!-- Ảnh 2 -->
        <div class="w-full h-full flex-shrink-0 flex items-center justify-center">
          <img src="{{ product.image.url }}" alt="{{ product.name }} - 2"
               class="w-full h-full object-cover object-center">
        </div>
        <!-- Ảnh 3 -->
        <div class="w-full h-full flex-shrink-0 flex items-center justify-center">
          <img src="{{ product.image.url }}" alt="{{ product.name }} - 3"
               class="w-full h-full object-cover object-center">
        </div>
        {% endif %}
      </div>

      <!-- Navigation Arrows - Chỉ hiện khi có nhiều ảnh -->
      {% if product.image %}
      <button id="prevImage" class="absolute left-4 top-1/2 transform -translate-y-1/2 w-10 h-10 bg-white/80 hover:bg-white rounded-full flex items-center justify-center shadow-lg transition-all">
        <span class="material-symbols-outlined !text-lg text-gray-700">chevron_left</span>
      </button>
      <button id="nextImage" class="absolute right-4 top-1/2 transform -translate-y-1/2 w-10 h-10 bg-white/80 hover:bg-white rounded-full flex items-center justify-center shadow-lg transition-all">
        <span class="material-symbols-outlined !text-lg text-gray-700">chevron_right</span>
      </button>
      {% endif %}
    </div>

    <!-- Image Dots Indicator - Chỉ hiện khi có nhiều ảnh -->
    {% if product.image %}
    <div class="flex justify-center mt-4 space-x-2">
      <button class="image-dot w-3 h-3 rounded-full bg-gray-700 transition-all" data-index="0"></button>
      <button class="image-dot w-3 h-3 rounded-full bg-gray-300 transition-all" data-index="1"></button>
      <button class="image-dot w-3 h-3 rounded-full bg-gray-300 transition-all" data-index="2"></button>
    </div>
    {% endif %}
  </div>

  <!-- Thông tin sản phẩm -->
  <div class="flex flex-col text-gray-800 px-8 pt-12">
    <h2 class="text-5xl font-bold mb-4">{{ product.name }}</h2>

    <!-- Giá -->
    <div class="flex items-baseline gap-3 mb-4">
      <p class="text-2xl text-[#FF5532]">{{ product.price|vnd }} VND</p>
      {% if product.old_price %}
      <p class="text-gray-400 line-through">{{ product.old_price|vnd }} VND</p>
      {% endif %}
    </div>

    <!-- Tình trạng -->
    <div class="flex items-center gap-2 mb-8">
      {% if product.stock > 0 %}
      <div
        class="inline-flex items-center gap-2 bg-green-100 text-green-700 px-5 py-3 rounded-full text-sm font-semibold">
        <span class="relative flex items-center justify-center w-4 h-4">
          <span class="absolute w-4 h-4 rounded-full border border-green-400"></span>
          <span class="w-3 h-3 bg-green-500 rounded-full"></span>
        </span>
        In stock, ready to ship
      </div>
      {% else %}
      <div class="inline-flex items-center gap-2 bg-red-100 text-red-600 px-5 py-3 rounded-full text-sm font-semibold">
        <span class="relative flex items-center justify-center w-4 h-4">
          <span class="absolute w-4 h-4 rounded-full border border-red-400"></span>
          <span class="w-3 h-3 bg-red-500 rounded-full"></span>
        </span>
        Out of stock
      </div>
      {% endif %}
    </div>

    <!-- Mô tả -->
    <div class="mb-8">
      <p class="text-gray-600 leading-relaxed">{{ product.description }}</p>
    </div>

    <form hx-post="{% url 'cart:modify' %}" hx-target="#cart-tab" hx-swap="innerHTML" class="flex flex-col gap-4">
      {% csrf_token %}
      <input type="hidden" name="product" value="{{ product.pk }}">
      <input type="hidden" name="action" value="add">
      <div class="flex items-center gap-3">
        <!-- Bộ chọn số lượng -->
        <div class="flex h-full items-center justify-between border-2 border-gray-300 rounded-full px-6 flex-[1]">
          <button type="button" onclick="changeQty(this, -1)">
            <span class="material-symbols-outlined !text-sm leading-none cursor-pointer">arrow_back_ios_new</span>
          </button>
          <input id="qty-input" name="qty" type="number" min="1" value="1" max="{{ product.stock }}"
            class="w-10 text-center outline-none border-none bg-transparent text-base font-medium" />
          <button type="button" onclick="changeQty(this, 1)">
            <span class="material-symbols-outlined !text-sm leading-none cursor-pointer">arrow_forward_ios</span>
          </button>
        </div>

        <button type="submit"
          class="flex-1 bg-black text-white hover:opacity-80 active:opacity-100 transition py-4 rounded-full border-2 border-black font-semibold flex-[3]"
          {% if product.stock == 0 %} disabled {% endif %}>
          Thêm vào giỏ hàng
        </button>
      </div>
    </form>

    <!-- Sản phẩm liên quan -->
    <div class="mt-10">
      <div class="flex items-center justify-between mb-3 gap-4">
        <h3 class="flex-1 text-lg font-semibold border-b border-gray-200 pb-2">Sản phẩm liên quan</h3>
        <div class="flex gap-2">
          <button id="prevBtn"
            class="w-8 h-8 border rounded-full flex items-center justify-center hover:bg-black hover:text-white transition">
            <span class="material-symbols-outlined !text-sm leading-none">arrow_back_ios_new</span>
          </button>
          <button id="nextBtn"
            class="w-8 h-8 border rounded-full flex items-center justify-center hover:bg-black hover:text-white transition">
            <span class="material-symbols-outlined !text-sm leading-none">arrow_forward_ios</span>
          </button>
        </div>
      </div>

      <div class="overflow-hidden">
        <div id="relatedContainer" class="flex transition-transform duration-500 ease-in-out">
          {% for rp in related_products %}
          <div class="w-1/3 flex-shrink-0 px-2">
            <a href="{% url 'products:detail' rp.slug %}"
              class="block bg-gray-50 rounded-xl p-3 flex flex-col items-center shadow-sm hover:shadow-md hover:scale-[1.02] transition">
              <div class="w-full aspect-square rounded-lg overflow-hidden bg-gray-100 mb-2">
                {% if rp.image %}
                <img src="{{ rp.image.url }}" alt="{{ rp.name }}" class="object-cover w-full h-full">
                {% else %}
                <span class="text-gray-400 text-sm flex items-center justify-center h-full">Không có ảnh</span>
                {% endif %}
              </div>
              <p class="font-medium text-sm text-center truncate w-full">{{ rp.name }}</p>
              <p class="text-[#FF5532] font-semibold text-sm text-center">
                {{ rp.price|vnd }} VND
              </p>
            </a>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  // Thay đổi số lượng
  function changeQty(btn, delta) {
    const input = btn.closest('div').querySelector('input[type=number]');
    const current = parseInt(input.value) || 1;
    input.value = Math.max(1, current + delta);
  }

  // Carousel sản phẩm liên quan
  const container = document.getElementById("relatedContainer");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");

  if (container && prevBtn && nextBtn) {
    const totalItems = container.children.length;
    const itemsPerView = 3;
    const maxIndex = Math.ceil(totalItems / itemsPerView) - 1;
    let index = 0;

    function updateCarousel() {
      const translateX = -index * 100;
      container.style.transform = `translateX(${translateX}%)`;
    }

    nextBtn.addEventListener("click", () => {
      if (index < maxIndex) index++;
      else index = 0;
      updateCarousel();
    });

    prevBtn.addEventListener("click", () => {
      if (index > 0) index--;
      else index = maxIndex;
      updateCarousel();
    });
  }

  // Image Slider Functionality
  const imageSlider = document.getElementById('imageSlider');
  const prevImageBtn = document.getElementById('prevImage');
  const nextImageBtn = document.getElementById('nextImage');
  const imageDots = document.querySelectorAll('.image-dot');

  // Chỉ khởi tạo slider nếu có nhiều hơn 1 ảnh
  if (imageSlider && imageSlider.children.length > 1) {
    let currentImageIndex = 0;
    const totalImages = imageSlider.children.length;

    function updateImageSlider() {
      imageSlider.style.transform = `translateX(-${currentImageIndex * 100}%)`;

      // Update dots
      imageDots.forEach((dot, index) => {
        dot.classList.toggle('bg-gray-700', index === currentImageIndex);
        dot.classList.toggle('bg-gray-300', index !== currentImageIndex);
      });
    }

    if (prevImageBtn && nextImageBtn) {
      prevImageBtn.addEventListener('click', () => {
        currentImageIndex = (currentImageIndex - 1 + totalImages) % totalImages;
        updateImageSlider();
      });

      nextImageBtn.addEventListener('click', () => {
        currentImageIndex = (currentImageIndex + 1) % totalImages;
        updateImageSlider();
      });
    }

    // Dot navigation
    imageDots.forEach(dot => {
      dot.addEventListener('click', () => {
        currentImageIndex = parseInt(dot.getAttribute('data-index'));
        updateImageSlider();
      });
    });

    // Khởi tạo slider
    updateImageSlider();
  }
</script>

<style>
  .image-dot {
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .image-dot:hover {
    background-color: #6b7280 !important;
  }

  #imageSlider {
    display: flex;
    transition: transform 0.5s ease-in-out;
  }
</style>
{% endblock %}